<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Top Grossing Tracker</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; margin: 20px; }
        h1 { margin-bottom: 0; }
        .dates { color: #666; margin-bottom: 10px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 13px; }
        th { background: #f5f5f5; text-align: left; }
        tr:nth-child(even) { background: #fafafa; }
        .status-up { color: green; font-weight: 600; }
        .status-down { color: #d9534f; font-weight: 600; }
        .status-new { color: #0275d8; font-weight: 600; }
        .status-out { color: #999; font-weight: 600; }
        .status-neutral { color: #666; }
        .bundle { font-family: monospace; font-size: 11px; color: #666; }
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; background: #eee; margin-right: 5px; }
        form.filters { margin: 15px 0; font-size: 13px; }
        form.filters label { margin-right: 12px; }
        form.filters input[type="number"] { width: 80px; }
        form.filters input[type="date"] { font-size: 12px; }
        .quick-filter { 
            padding: 4px 10px; 
            margin-right: 5px; 
            border: 1px solid #ddd; 
            background: #f8f8f8; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 12px;
        }
        .quick-filter:hover { background: #e8e8e8; }
        .quick-filter.active { 
            background: #0275d8; 
            color: white; 
            border-color: #0275d8; 
        }
        .quick-filter.active:hover { background: #025aa5; }
        .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
            font-size: 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<h1>App Store Top Grossing (US, non-gaming)</h1>

<div class="dates">
    {% if today %}
        Comparing:
        <strong>{{ compare_date if compare_date else "‚Äî" }}</strong>
        &nbsp;‚Üí&nbsp;
        <strong>{{ today }}</strong>
    {% else %}
        –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –í—ã–∑–æ–≤–∏ /fetch-now, —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É—Ç—å –ø–µ—Ä–≤—ã–π —Å—Ä–µ–∑.
    {% endif %}
</div>

<div class="badge">{{ chart_type }}</div>
<div class="badge">country: {{ country }}</div>
<div class="badge" style="background: #e7f3ff; color: #0275d8; cursor: help;" title="Estimates based on position, category traffic multipliers, and industry benchmarks">
    üìä Analytics: Estimates
</div>

<form method="get" class="filters" id="filters-form">
    <label>
        Category:
        <select name="category" onchange="document.getElementById('filters-form').submit()">
            <option value="">All categories</option>
            {% for cid, cname in categories %}
                <option value="{{ cid }}" {% if selected_category == cid %}selected{% endif %}>{{ cname }}</option>
            {% endfor %}
        </select>
    </label>

    <label>
        Min jump (positions):
        <input type="number" name="min_jump"
               value="{{ min_jump if min_jump is not none else '' }}"
               onchange="document.getElementById('filters-form').submit()">
    </label>

    <label>
        From:
        <input type="date" name="from_date" value="{{ from_date or '' }}"
               onchange="document.getElementById('filters-form').submit()">
    </label>

    <label>
        To:
        <input type="date" name="to_date" value="{{ to_date or '' }}"
               onchange="document.getElementById('filters-form').submit()">
    </label>

    <label>
        Sort by:
        <select name="sort_by" onchange="document.getElementById('filters-form').submit()">
            <option value="">Position</option>
            <option value="new" {% if sort_by == "new" %}selected{% endif %}>NEW First</option>
            <option value="delta" {% if sort_by == "delta" %}selected{% endif %}>Biggest Jump</option>
            <option value="release" {% if sort_by == "release" %}selected{% endif %}>üÜï Recent Release</option>
        </select>
    </label>

    <button type="submit">Apply</button>
    <button
        type="button"
        id="refresh-btn"
        style="margin-left: 12px;"
        onclick="startRefresh()">
        Refresh now
    </button>
    <span id="loading-indicator" style="display: none; margin-left: 10px; color: #0275d8; font-size: 13px;">
        <span class="spinner">‚ü≥</span> Parsing 23 categories... This may take 2-3 minutes
    </span>
</form>

<div style="margin: 10px 0; font-size: 13px;">
    <strong>Quick filters:</strong>
    <button type="button" class="quick-filter {% if only_new == 'true' %}active{% endif %}" onclick="toggleOnlyNew()">
        {% if only_new == 'true' %}‚úì {% endif %}Only NEW
    </button>
    <button type="button" class="quick-filter {% if sort_by == 'release' %}active{% endif %}" onclick="setSortByRelease()">
        {% if sort_by == 'release' %}‚úì {% endif %}üìÖ Sort by Date
    </button>
    
    <span style="margin: 0 5px;">|</span>
    
    <button type="button" class="quick-filter" onclick="setMinJump(10)">Jump +10</button>
    <button type="button" class="quick-filter" onclick="setMinJump(20)">Jump +20</button>
    <button type="button" class="quick-filter" onclick="setMinJump(30)">Jump +30</button>
    <button type="button" class="quick-filter" onclick="setMinJump(50)">Jump +50</button>
    <button type="button" class="quick-filter" onclick="clearJump()">Clear Jump Filter</button>
    
    <span style="margin: 0 5px;">|</span>
    
    <button type="button" class="quick-filter {% if recent_days == 30 %}active{% endif %}" onclick="setRecentDays(30)">
        {% if recent_days == 30 %}‚úì {% endif %}üÜï Last 30 days
    </button>
    <button type="button" class="quick-filter {% if recent_days == 60 %}active{% endif %}" onclick="setRecentDays(60)">
        {% if recent_days == 60 %}‚úì {% endif %}Last 60 days
    </button>
    <button type="button" class="quick-filter {% if recent_days == 90 %}active{% endif %}" onclick="setRecentDays(90)">
        {% if recent_days == 90 %}‚úì {% endif %}Last 90 days
    </button>
    <button type="button" class="quick-filter" onclick="clearRecentDays()">Clear Date Filter</button>
</div>

<script>
function startRefresh() {
    const btn = document.getElementById('refresh-btn');
    const indicator = document.getElementById('loading-indicator');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    btn.disabled = true;
    btn.textContent = 'Parsing...';
    indicator.style.display = 'inline';
    
    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ endpoint –ø–∞—Ä—Å–∏–Ω–≥–∞
    window.location.href = '/fetch-now?token=super_secret_token_change_me&redirect=true';
}

function toggleOnlyNew() {
    const url = new URL(window.location);
    if (url.searchParams.get('only_new') === 'true') {
        url.searchParams.delete('only_new');
    } else {
        url.searchParams.set('only_new', 'true');
    }
    window.location.href = url.toString();
}

function setMinJump(value) {
    const form = document.getElementById('filters-form');
    const input = form.querySelector('[name="min_jump"]');
    input.value = value;
    form.submit();
}
function clearJump() {
    const form = document.getElementById('filters-form');
    const input = form.querySelector('[name="min_jump"]');
    input.value = '';
    form.submit();
}

function setRecentDays(days) {
    const url = new URL(window.location);
    url.searchParams.set('recent_days', days);
    window.location.href = url.toString();
}

function clearRecentDays() {
    const url = new URL(window.location);
    url.searchParams.delete('recent_days');
    window.location.href = url.toString();
}

function setSortByRelease() {
    const url = new URL(window.location);
    if (url.searchParams.get('sort_by') === 'release') {
        // –ï—Å–ª–∏ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ, –æ—Ç–∫–ª—é—á–∞–µ–º –µ—ë
        url.searchParams.delete('sort_by');
    } else {
        // –í–∫–ª—é—á–∞–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ –¥–∞—Ç–µ —Ä–µ–ª–∏–∑–∞
        url.searchParams.set('sort_by', 'release');
    }
    window.location.href = url.toString();
}
</script>

<table>
    <thead>
    <tr>
        <th>App</th>
        <th>Bundle ID</th>
        <th>Category</th>
        <th>Release Date</th>
        <th>Pos (today)</th>
        <th>Pos (prev)</th>
        <th>Œî / Status</th>
        <th>üìä Analytics</th>
    </tr>
    </thead>
    <tbody>
    {% for row in rows %}
        <tr>
            <td>
                {% if row.store_url %}
                    <a href="{{ row.store_url }}" target="_blank" rel="noopener noreferrer">
                        {{ row.name }}
                    </a>
                {% else %}
                    {{ row.name }}
                {% endif %}
            </td>
            <td class="bundle">{{ row.bundle_id }}</td>
            <td>{{ row.category_name }}</td>
            <td style="font-size: 12px; color: #666;">{{ row.release_date if row.release_date else "-" }}</td>
            <td>{{ row.today_pos if row.today_pos is not none else "-" }}</td>
            <td>{{ row.prev_pos if row.prev_pos is not none else "-" }}</td>
            <td>
                {% if row.status == "NEW" %}
                    <span class="status-new">{{ row.status }}</span>
                {% elif row.status.startswith("+") %}
                    <span class="status-up">{{ row.status }}</span>
                {% elif row.status.startswith("-") %}
                    <span class="status-down">{{ row.status }}</span>
                {% elif row.status.startswith("OUT") %}
                    <span class="status-out">{{ row.status }}</span>
                {% else %}
                    <span class="status-neutral">{{ row.status }}</span>
                {% endif %}
            </td>
            <td style="font-size: 11px;">
                <div style="margin-bottom: 3px;">
                    <strong>üì• {{ "{:,}".format(row.est_installs_min) }}‚Äì{{ "{:,}".format(row.est_installs_max) }}</strong> /day
                </div>
                <div style="color: #28a745; margin-bottom: 3px;">
                    <strong>üí∞ ${{ "{:,}".format(row.est_revenue_min // 1000) }}k‚Äì${{ "{:,}".format(row.est_revenue_max // 1000) }}k</strong> /mo
                </div>
                {% if row.traffic_impact %}
                <div style="color: #666; font-size: 10px;">
                    {{ row.traffic_impact }}
                </div>
                {% endif %}
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

</body>
</html>